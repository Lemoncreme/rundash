!function(){"use strict";var i={keymap:{" ":32,space:32,spacebar:32,control:33,shift:34,alt:35,tab:36,return:37,enter:38,lshift:39,arrowleft:40,left:40,arrowright:41,right:41,arrowup:42,up:42,arrowdown:43,down:43,",":44,"-":45,".":46,"/":47,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,":":58,";":59,"<":60,"=":61,">":62,"?":63,"@":64,home:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"[":91,"":92,"]":93,"^":94,F1:95,"`":96,a:97,b:98,c:99,d:100,e:101,f:102,g:103,h:104,i:105,j:106,k:107,l:108,m:109,n:110,o:111,p:112,q:113,r:114,s:115,t:116,u:117,v:118,w:119,x:120,y:121,z:122,"{":123,"|":124,"}":125,"~":126},keys:new Uint8Array(128),keyspressed:new Uint8Array(128),down:function(){return!!Array.from(arguments).find(function(t){return 1==i.keys[i.keymap[t]]})},pressed:function(){return!!Array.from(arguments).find(function(t){return 1==i.keyspressed[i.keymap[t]]})}};$(document).keydown(function(t){i.keys[i.keymap[t.key.toLowerCase()]]=1,i.keyspressed[i.keymap[t.key.toLowerCase()]]=1,d.anykey=!0}),$(document).keyup(function(t){i.keys[i.keymap[t.key.toLowerCase()]]=0}),$(window).resize(function(){"loading"!=A.status&&T.zoom()});var s={right:!1,righthold:!1,left:!1,lefthold:!1,last:-1,time:0,timer:null},d={jump:function(){return i.down("space","w","up")||s.right||s.left},right:function(){return i.down("right","d")||s.righthold},left:function(){return i.down("left","a")||s.lefthold},anykey:!1};$(document).on("touchstart",function(t){(s.righthold||s.lefthold)&&(s.right=!0);var e=t.touches[0].clientX,i=t.touches[0].clientY;T.rot&&i>window.innerWidth/2||!T.rot&&e>window.innerWidth/2?s.righthold=!0:s.lefthold=!0}),$(document).on("touchend",function(t){0==t.touches.length&&(s.righthold=!1,s.lefthold=!1)}),$(document).on("touchmove",function(){s.righthold=s.lefthold=!1;var t=event.clientX,e=event.clientY;T.rot&&e>window.innerWidth/2||!T.rot&&t>window.innerWidth/2?s.righthold=!0:s.lefthold=!0});var t=location.href,n=io.connect(t),c=sprintf,l=($(document.body),$("#game")),p=$("#msg"),o=$("#login"),a=$("#login .player"),f=$("#i"),e=$(".leaderboard"),y=$(".leaderboard p#placement"),u=$(".leaderboard tbody"),g=$("#linfo"),m=$("#sml-leaderboard"),x=$("#login-msg"),v=1,w=2,b=4,k=8,M=[":",";","8","B"],j=["}","]",")","(","[","{","|","\\",">","&","L","I","D","3","1","P","B","S"],z={join:1,leave:2,game:3,update:4,login:5,init:6,endgame:7,win:8,dead:9,info:10,leaderboard:11,lobbyinfo:12};function C(t,e){n.connected&&n.emit("msg",msgpack.encode([t,e]))}function B(t,e,i){return(1-i)*t+i*e}n.on("connect",function(){console.log(c("connected to %s",n.io.uri)),A.setstatus("loading")}),n.on("msg",function(t){var e,i,s,n,o=(s=t,msgpack.decode(new Uint8Array(s.data))),a=o[1];switch(o[0]){case z.init:console.log("initialized"),W.sid=a.sid,W.friction=a.drag,W.gravity=a.gravity,W.jumpspeed=a.vspeed,W.speed=a.hspeed,T.target=W,A.setstatus("login");break;case z.info:var h=a.split(";").join("<br>");g.html(h);break;case z.game:console.log("game %d started",a.number),A.setstatus("game"),F.create(a.data);for(var r=0;r<a.players.length;r++)a.players[r].gid!=W.gid&&new S("friend",0,0,65,65,a.players[r].name,"",a.players[r].gid);break;case z.update:for(r=0;r<a.gid.length;r++)a.gid[r]!=W.gid&&(e=F.actors[F.findByIndex(a.gid[r])])&&!e.halt&&(e.px=e.nx,e.py=e.ny,e.nx=a.x[r],e.ny=a.y[r],e.itime=Date.now()/1e3-e.lastupdate,e.lastupdate=Date.now()/1e3,e.pvx=e.nvx,e.pvy=e.nvy,e.nvx=a.vx[r],e.nvy=a.vy[r]);f.text(c("%d seconds left",a.time));break;case z.join:console.log("joined game %d",a.number),A.setstatus("lobby"),W.gid=a.gid,F.spawnx=W.x=a.x,F.spawny=W.y=a.y;break;case z.leave:console.log("player %d left",a.index),a.index!=W.gid&&F.removeByIndex(a.index);break;case z.endgame:console.log("game ended"),A.setstatus("endgame"),$(".leaderboard tr").remove("tr:not(#header)"),i=-1;for(var d,l,r=0;r<a.length;r++)l=!Boolean(a[r].time),a[r].sid!=W.sid||l||(i=r+1),u.append(d=$("<tr>",{class:(a[r].sid==W.sid?"me ":"")+(l?"dnf":"")})),d.append($("<td>",{text:l?"":(r+1).toString()})),d.append($("<td>",{text:a[r].name})),d.append($("<td>",{text:l?"DNF":(a[r].time/20).toFixed(1)+" sec"}));switch(y.removeClass("winner"),i){case-1:y.text("Did Not Finish");break;case 1:y.text("1st Place!"),y.addClass("winner");break;case 2:y.text("2nd Place");break;case 3:y.text("3rd Place");break;default:y.text("Runner Up")}break;case z.win:console.log("win: %.2f seconds",a.time/20);break;case z.login:console.log(a),n=a,p.text(n),p.removeClass("dropdown"),setTimeout(function(){p.addClass("dropdown")},100);break;case z.dead:if(a.gid==W.gid)break;(e=F.actors[F.findByIndex(a.gid)]).x=a.x+2*e.vx,e.y=a.y+2*e.vy,e.die(),console.log("Recieved dead on player ",a.gid);break;case z.leaderboard:m.html("<p>"+a.join("</p><p>")+"</p>");break;case z.lobbyinfo:console.log(a),x.html(a.split(";").join("<br>"))}}),n.on("disconnect",function(){console.log("disconnected from server"),A.setstatus("disconnected")});var h,F={maxprops:180,props:[],actors:[],spawnx:0,spawny:0,update:function(){for(var t=0;t<this.actors.length;t++)this.actors[t].update();this.timer++},addprop:function(t){this.props.push(t),this.props.length>this.maxprops&&this.props.find(function(t,e){return"grave"==t.type&&(t.devare(),this.props.splice(e,1),!0)},this)},create:function(t){for(var e=0,i=0,s=JSON.parse(t).props,n=0;n<s.length;n++)new D(s[n].type,Math.floor(s[n].x),Math.floor(s[n].y),Math.floor(s[n].w),Math.floor(s[n].h)),e=Math.min(s[n].x,e),i=Math.min(s[n].y,i);e-=1e3,i-=1e3,this.bound(e,i)},findByIndex:function(e){return this.actors.findIndex(function(t){return t.gid==e})},removeByIndex:function(t){var e=this.findByIndex(t);-1!=e?(this.actors[e].devare(),this.actors.splice(e,1)):console.error("tried to remove actor #%d, but it doesn't exist",t)},clear:function(){for(var t=this.props.length-1;0<=t;t--)this.props.pop().devare();for(t=this.actors.length-1;1<=t;t--)this.actors.pop().devare()},bound:function(t,e){l.css("left",-Math.min(0,t)+"px"),l.css("top",-Math.min(0,e)+"px"),T.offsetx=-t,T.offsety=-e},timer:0},I=(h={},Array.from($("audio")).forEach(function(t){this[t.id]=t},h),h),A={status:"loading",setstatus:function(t){switch(console.info(c("STATUS: %s -> %s",this.status,t)),this.status){case"loading":$(".loading").hide();break;case"login":o.hide(),$("#login-msg").hide();break;case"lobby":$("#title").hide(),$(".loading").hide();break;case"game":f.hide(),l.hide(),m.hide();break;case"endgame":e.hide();break;case"newgame":break;case"disconnected":$(".disconnected").hide()}switch(this.status=t){case"loading":T.update(),$(".loading").show(),$(".disconnected").hide();break;case"login":$("#title").show(),$("#login-msg").show(),o.show(),T.target=null,T.reset();break;case"lobby":$("#title").show(),$(".loading").show(),$(".disconnected").hide(),F.clear();break;case"game":f.show(),l.show(),T.target=W,T.zoom(),T.reset(),m.empty(),m.show();break;case"endgame":e.show(),T.target=null,T.update();break;case"newgame":C(z.game,0),this.setstatus("lobby");break;case"disconnected":$(".disconnected").show(),$("#title").hide(),F.clear()}}},T={x:0,y:0,offsetx:0,offsety:0,currFFZoom:1,currIEZoom:100,zoomlvl:1,rot:!1,target:null,speed:.1,update:function(){this.target?(this.follow(),this.rot?window.scrollTo(this.offsety+this.y,this.offsetx+this.x):window.scrollTo(this.offsetx+this.x,this.offsety+this.y)):window.scrollTo(0,0)},zoom:function(){var t=this.rot;this.rot=1<window.innerHeight/window.innerWidth,this.rot,this.zoomlvl=(window.innerWidth+window.innerHeight)/2e3+(this.rot?.3:0),this.zoomlvl*=.7,this.zoomlvl.toFixed(1),l.css("transform",c("scale(%1$f, %1$f)",this.zoomlvl)),this.reset()},follow:function(){this.x=B(this.x,this.fx(),this.speed),this.y=B(this.y,this.fy(),this.speed)},reset:function(){this.target&&(this.x=this.fx(),this.y=this.fy()),"login"==A.status&&(this.y*=1.5),this.update()},fx:function(){return(this.target.x+this.target.w/2)*this.zoomlvl-(this.rot?window.innerHeight:window.innerWidth)/2},fy:function(){return(this.target.y+this.target.h/2)*this.zoomlvl-(this.rot?window.innerWidth:window.innerHeight)/2}},r=0,W=new S("player",0,0,65,65);function D(t,e,i,s,n,o){this.type=t,this.x=e||0,this.y=i||0,this.w=s||2,this.h=n||2,this.solid="grave"!=t;var a=$("<div>",{class:t,style:c("left:%dpx;top:%dpx;width:%dpx;height:%dpx;",this.x,this.y,this.w,this.h),text:o||""});l.append(a),F.addprop(this),this.devare=function(){a.remove()}}function S(t,e,i,s,n,o,a,h){this.name=o,this.x=e||0,this.y=i||0,this.w=s||30,this.h=n||30,this.vx=0,this.vy=0,this.dx=0,this.dy=0,this.pvx=0,this.pvy=0,this.nvx=0,this.nvy=0,this.px=0,this.py=0,this.nx=0,this.ny=0,this.npos=[0,0],this.interp=0,this.itime=1,this.lastupdate=Date.now()/1e3,this.sid=a||"",this.gid=h||0,this.face=":)",this.type=t,this.speed=6.5,this.jumpspeed=18,this.gravity=.8,this.friction=.35,this.halt=!1;var r=$("<div>",{class:t,style:c("width:%dpx;height:%dpx;",s,n),text:this.face});l.append(r),F.actors.push(this),this.seedface=function(t){this.name=t,Math.seedrandom(t),this.face=M[Math.floor(Math.random()*M.length)]+j[Math.floor(Math.random()*j.length)],r.text(this.face),"friend"==this.type&&r.append($("<p>",{text:this.name}))},this.move=function(t,e){this.x+=t,this.y+=e,r.css("transform",c("translate(%dpx, %dpx) scale(%.2f, %.2f) rotate(%.2fdeg)",this.x,this.y,1+Math.abs(this.dx/75),1+Math.abs(this.dy/75),this.dx))},this.update=function(){var a,h;if(!this.halt)switch(this.type){case"player":this.vx*=this.friction,d.right()&&(this.vx+=this.speed),d.left()&&(this.vx-=this.speed),this.canjump&&d.jump()&&(this.vy=-this.jumpspeed,I.jump.play(),this.canjump=!1),this.vy+=this.gravity,99999<this.y&&this.die(),this.dx=this.vx,this.dy=this.vy,this.move(this.vx,this.vy);var t=this.vy,e=(a=this,h=0,F.props.forEach(function(t){if(t.solid&&a.y+a.h>=t.y&&a.y<=t.y+t.h&&a.x+a.w>=t.x&&a.x<=t.x+t.w){if(-1<t.type.search("spike"))return void a.die();if("platform goal"==t.type)return void a.win();var e=a.y+a.h-t.y,i=t.y+t.h-a.y,s=a.x+a.w-t.x,n=t.x+t.w-a.x,o=Math.min(Math.abs(e),Math.abs(i),Math.abs(s),Math.abs(n));o==e?(a.y=t.y-a.h,a.vy=0,h|=v):o==i?(a.y=t.y+t.h,a.vy=-a.vy/2+.1,h|=w):o==s?(a.x=t.x-a.w,h|=k):o==n&&(a.x=t.x+t.w,h|=b),a.move(0,0)}}),h);1.5<t&&0===this.vy&&e&v&&I.land.play(),e&v&&(this.canjump=!0);break;case"friend":this.interp=Math.min((Date.now()/1e3-this.lastupdate)/this.itime,1),this.vx=B(this.pvx,this.nvx,this.interp),this.vy=B(this.pvy,this.nvy,this.interp),this.x=B(this.px,this.nx,this.interp),this.y=B(this.py,this.ny,this.interp),this.dx=this.vx,this.dy=this.vy,this.move(0,0)}},this.die=function(){this.x-=this.vx,this.y-=this.vy,new D("grave",this.x+6,this.y-10,60,80,this.face),new U(this.x+this.w/2,this.y+this.h/2,"4star.svg"),this.vx=this.vy=0,r.addClass("padshrink"),"player"==this.type?(I.die.play(),C(z.dead,{x:this.x,y:this.y}),T.speed=0,this.suspend(!1,750,!0)):this.suspend(!1,1e3,!0)},this.win=function(){"player"==this.type&&(this.vx=this.vy=0,new U(this.x+this.w/2,this.y+this.h/2,"star.svg"),C(z.win,0),I.win.play(),this.suspend(!1,750,!0),r.addClass("padshrink"))},this.devare=function(){r.remove()},this.hide=function(){r.hide()},this.unhide=function(){r.show()},this.suspend=function(t,e,i){this.halt=!0,t&&this.hide();var s=this;setTimeout(function(){s.unsuspend(i)},e)},this.unsuspend=function(t){t&&(this.x=F.spawnx,this.y=F.spawny,this.move(0,0)),T.speed=.1,this.halt=!1,this.unhide(),r.removeClass("padshrink")},o&&this.seedface(o)}function U(t,e,i){var s=$("<img>",{class:"spinfect",src:"../img/"+i,style:c("top:%dpx; left:%dpx;",e-100,t-100)});l.append(s),this.devare=function(){s.remove()},setTimeout(this.devare,2e3)}A.setstatus("loading"),T.zoom(),I.music.play(),window.requestAnimationFrame(function t(){switch(window.requestAnimationFrame(t),r++,A.status){case"game":F&&(F.update(),0),T.update(),r%3==0&&C(z.update,{x:W.x,y:W.y,vx:W.vx,vy:W.vy});break;case"login":d.anykey&&(W.seedface(o.find("input").val()),a.text(W.face)),i.pressed("home")&&C(z.login,"player")}for(var e=0;e<128;i.keyspressed[e]=0,e++);s.right=!1,s.left=!1,d.anykey=!1}),window._g_login=function(t){C(z.login,t)},window._g_status=function(t){A.setstatus(t)}}();